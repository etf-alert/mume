<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Chart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #0f172a;
      color: #e5e7eb;
      font-family: -apple-system, BlinkMacSystemFont;
      padding: 12px;
    }
    h2 { margin-bottom: 10px; }
    canvas {
      background: #020617;
      border-radius: 10px;
      margin-bottom: 16px;
    }
    .box {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 10px;
      padding: 12px;
    }
    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .row.split { gap: 10px; }
    .field { flex: 1; }
    .field input { width: 90%; }
    .label { color: #93c5fd; font-size: 14px; }
    .value { font-weight: 600; }
    input {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #334155;
      padding: 6px;
      border-radius: 6px;
      text-align: right;
      font-size: 16px;
    }
    .sell { color: #facc15; }
    .buy { color: #22c55e; }
    .hint {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 1px;
    }
    
    #pullIndicator {
      position: fixed;
      top: -40px;
      left: 0;
      right: 0;
      height: 40px;
      background: #020617;
      color: #93c5fd;
      text-align: center;
      line-height: 40px;
      font-size: 13px;
      z-index: 9999;
      transition: top 0.2s;
    }

  </style>
</head>
<body>

<h2 id="title">ğŸ“ˆ Chart</h2>
<canvas id="priceChart" height="200"></canvas>
<canvas id="rsiChart" height="120"></canvas>

<div id="pullIndicator">â¬‡ï¸ ë‹¹ê²¨ì„œ ìƒˆë¡œê³ ì¹¨</div>

<div class="box">
  <div class="row">
    <div class="label">í˜„ì¬ê°€</div>
    <div id="currentPrice" class="value">-</div>
  </div>

  <div class="row split">
    <div class="field">
      <div class="label">ì‹œë“œ ê¸ˆì•¡</div>
      <input id="seedInput" type="text" inputmode="decimal" placeholder="$0" />
    </div>
    <div class="field">
      <div class="label">í‰ë‹¨ê°€</div>
      <input id="avgInput" type="text" inputmode="decimal" placeholder="$0" />
    </div>
  </div>

  <div class="row">
    <div class="label">ë§¤ë„ê°€ (í‰ë‹¨ê°€ +10%)</div>
    <div id="sellPrice" class="value sell">-</div>
  </div>

  <div class="row">
    <div class="label">í‰ë‹¨ê°€ / ê°€ëŠ¥ ìˆ˜ëŸ‰</div>
    <div id="avgBuyLine" class="value buy">-</div>
  </div>

  <div class="row">
    <div class="label">LOC í° ìˆ˜ ë§¤ìˆ˜ê°€ / ê°€ëŠ¥ ìˆ˜ëŸ‰</div>
    <div id="locBuy" class="value buy">-</div>
  </div>

  <div class="hint">
    â€» LOC í° ìˆ˜ ë§¤ìˆ˜ê°€ëŠ” â€œí‰ë‹¨ê°€ +5%â€ ì™€ â€œí˜„ì¬ê°€ +15%â€ ì¤‘ ë” ë‚®ì€ ê°€ê²©
  </div>

  <div class="row split">
    <div class="field">
      <div class="label">í‰ë‹¨ê°€ +5%</div>
      <div id="avgPlus5" class="value">-</div>
    </div>
    <div class="field">
      <div class="label">í˜„ì¬ê°€ +15%</div>
      <div id="pricePlus15" class="value">-</div>
    </div>
  </div>

  <div class="row split">
    <div class="field">
      <div class="label">40ë¶„í•  ê¸ˆì•¡</div>
      <div id="split40" class="value">-</div>
    </div>
    <div class="field">
      <div class="label">ì‚¬ìš© ê¸ˆì•¡ (80ë¶„í• )</div>
      <div id="halfSplit" class="value">-</div>
    </div>
    
  </div>
</div>

<script>
/* ===== ê¸°ë³¸ ì„¤ì • ===== */
const params = new URLSearchParams(location.search);
const ticker = params.get("ticker");
const SHOW_DAYS = 252;

const seedInput = document.getElementById("seedInput");
const avgInput  = document.getElementById("avgInput");

const currentPriceEl = document.getElementById("currentPrice");
const sellPriceEl = document.getElementById("sellPrice");
const avgPlus5El = document.getElementById("avgPlus5");
const pricePlus15El = document.getElementById("pricePlus15");
const locBuyEl = document.getElementById("locBuy");
const split40El = document.getElementById("split40");
const halfSplitEl = document.getElementById("halfSplit");
  /* ===== ì…ë ¥ê°’ ë³µì› ===== */
const savedSeed = localStorage.getItem(`seed_${ticker}`);
const savedAvg  = localStorage.getItem(`avg_${ticker}`);

if (savedSeed) seedInput.value = savedSeed;
if (savedAvg)  avgInput.value  = savedAvg;

  
document.getElementById("title").innerText = `ğŸ“ˆ ${ticker}`;

let prices = [], rsis = [], labels = [], latestPrice = null;

/* ===== ìœ í‹¸ ===== */
function onlyNumber(v) {
  v = v.replace(/[^0-9.]/g, "");
  const p = v.split(".");
  if (p.length > 2) v = p[0] + "." + p.slice(1).join("");
  return v;
}
function formatNumber(v) {
  const [i, d] = v.split(".");
  const int = i.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  return d !== undefined ? `${int}.${d}` : int;
}
const getSeed = () => parseFloat(onlyNumber(seedInput.value) || "0");
const getAvg  = () => parseFloat(onlyNumber(avgInput.value) || "0");

/* ===== ë°ì´í„° ë¡œë“œ ===== */
fetch(`/chart/${ticker}`)
  .then(r => r.json())
  .then(data => {
    data.slice(-SHOW_DAYS).forEach(d => {
      labels.push(d.date);
      prices.push(d.price);
      rsis.push(d.rsi);
    });
    latestPrice = prices.at(-1);
    currentPriceEl.innerText = "$" + latestPrice.toFixed(2);
    drawCharts();
    updateLevels();
  });

/* ===== ì°¨íŠ¸ ===== */
function drawCharts() {
  const xTick = (_, i) => {
    const [y, m] = labels[i].split("-");
    return `${y.slice(2)}.${parseInt(m)}`;
  };

  new Chart(priceChart, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Price",
        data: prices,
        borderColor: "#60a5fa",
        borderWidth: 2,
        pointRadius: 0
      }]
    },
    options: {
      plugins: {
        legend: {
          labels: { color: "#e5e7eb" }
        }
      },
      scales: {
        x: {
          ticks: {
            maxTicksLimit: 6,
            callback: xTick,
            color: "#94a3b8"
          }
        },
        y: {
          ticks: { color: "#94a3b8" }
        }
      }
    }
  });

  new Chart(rsiChart, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "RSI (14)",
        data: rsis,
        borderColor: "#f87171",
        borderWidth: 2,
        pointRadius: 0
      }]
    },
    options: {
      plugins: {
        legend: {
          labels: { color: "#e5e7eb" }
        }
      },
      scales: {
        x: {
          ticks: {
            maxTicksLimit: 6,
            callback: xTick,
            color: "#94a3b8"
          }
        },
        y: {
          min: 10,
          max: 80,
          ticks: { color: "#94a3b8" }
        }
      }
    }
  });
}

/* ===== ê³„ì‚° ===== */
function updateLevels() {
  const seed = getSeed();
  const avg = getAvg();
  if (!seed || !avg || !latestPrice) return;

  const split40 = seed / 40;
  const halfSplit = split40 / 2;

  const sell = avg * 1.10;
  const avg5 = avg * 1.05;
  const price15 = latestPrice * 1.15;
  const locBuy = Math.min(avg5, price15);

  const avgQty = Math.floor(halfSplit / avg);
  const locQty = Math.floor(halfSplit / locBuy);

  sellPriceEl.innerText = "$" + sell.toLocaleString(undefined,{maximumFractionDigits:2});
  avgPlus5El.innerText = "$" + avg5.toLocaleString(undefined,{maximumFractionDigits:2});
  pricePlus15El.innerText = "$" + price15.toLocaleString(undefined,{maximumFractionDigits:2});

  document.getElementById("avgBuyLine").innerText =
    "$" + avg.toLocaleString(undefined,{maximumFractionDigits:2}) + " / " + avgQty + " ì£¼";

  locBuyEl.innerText =
    "$" + locBuy.toLocaleString(undefined,{maximumFractionDigits:2}) + " / " + locQty + " ì£¼";

  split40El.innerText = "$" + split40.toLocaleString(undefined,{maximumFractionDigits:2});
  halfSplitEl.innerText = "$" + halfSplit.toLocaleString(undefined,{maximumFractionDigits:2});
}

/* ===== ì…ë ¥ ===== */
seedInput.addEventListener("input", () => {
  const raw = onlyNumber(seedInput.value);
  seedInput.value = raw ? "$" + formatNumber(raw) : "";
  localStorage.setItem(`seed_${ticker}`, seedInput.value);
  updateLevels();
});

avgInput.addEventListener("input", () => {
  const raw = onlyNumber(avgInput.value);
  avgInput.value = raw ? "$" + formatNumber(raw) : "";
  localStorage.setItem(`avg_${ticker}`, avgInput.value);
  updateLevels();
});

  let startY = 0;
  let pulling = false;
  const indicator = document.getElementById("pullIndicator");

  window.addEventListener("touchstart", e => {
    if (window.scrollY === 0) {
      startY = e.touches[0].clientY;
      pulling = true;
    }
  });

  window.addEventListener("touchmove", e => {
    if (!pulling) return;
    const diff = e.touches[0].clientY - startY;
    if (diff > 0) {
      indicator.style.top = Math.min(diff - 40, 10) + "px";
      indicator.innerText = diff > 80 ? "ğŸ”„ ë†“ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨" : "â¬‡ï¸ ë‹¹ê²¨ì„œ ìƒˆë¡œê³ ì¹¨";
    }
  });

  window.addEventListener("touchend", e => {
    if (!pulling) return;
    const diff = e.changedTouches[0].clientY - startY;
    indicator.style.top = "-40px";
    pulling = false;
    if (diff > 80) {
      location.reload();
    }
  });

</script>
</body>
</html>
