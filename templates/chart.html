<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#020617">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <meta charset="UTF-8" />
  <title>Chart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.js"></script>
  <style>
    body {
      background: #0f172a;
      color: #e5e7eb;
      font-family: -apple-system, BlinkMacSystemFont;
      padding: 12px;
    }
    h2 { margin-bottom: 10px; }
    canvas {
      background: #020617;
      border-radius: 10px;
      margin-bottom: 16px;
    }
    .box {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 10px;
      padding: 12px;
    }
    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .row.split { gap: 10px; }
    .field { flex: 1; }
    .field input { width: 90%; }
    .label { color: #93c5fd; font-size: 14px; }
    .value { font-weight: 600; }
    input {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #334155;
      padding: 6px;
      border-radius: 6px;
      text-align: right;
      font-size: 16px;
    }
    .sell { color: #facc15; }
    .buy { color: #22c55e; }
    .hint {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 1px;
    }
    
    #pullIndicator {
      position: fixed;
      top: -40px;
      left: 0;
      right: 0;
      height: 40px;
      background: #020617;
      color: #93c5fd;
      text-align: center;
      line-height: 40px;
      font-size: 13px;
      z-index: 9999;
      transition: top 0.2s;
    }
    .badge {
      margin-left: 6px;
      padding: 2px 6px;
      font-size: 10px;
      font-weight: 700;
      border-radius: 4px;
      vertical-align: middle;
    }

    .badge.pre {
      background: #facc15;
      color: #000;
    }

    .badge.post {
      background: #38bdf8;
      color: #020617;
    }

    .badge.close {
      background: #64748b;
      color: white;
    }

  </style>
</head>
<body>

<h2 id="title">ğŸ“ˆ Chart</h2>
<canvas id="priceChart" height="200"></canvas>
<canvas id="rsiChart" height="120"></canvas>

<div id="pullIndicator">â¬‡ï¸ ë‹¹ê²¨ì„œ ìƒˆë¡œê³ ì¹¨</div>

<div class="box">
  <div class="row">
    <div class="label">í˜„ì¬ê°€</div>
    
    <div id="currentPrice" class="value">
      <div id="mainPriceLine"></div>
      <div id="subPriceLine" style="font-size:13px;margin-top:2px;"></div>
    </div>

  </div>

  <div class="row split">
    <div class="field">
      <div class="label">ì‹œë“œ ê¸ˆì•¡</div>
      <input id="seedInput" type="text" inputmode="decimal" placeholder="$0" />
    </div>
    <div class="field">
      <div class="label">í‰ë‹¨ê°€</div>
      <input id="avgInput" type="text" inputmode="decimal" placeholder="$0" />
    <div class="hint" id="avgStatus">í‰ë‹¨ê°€ ìˆ˜ë™ ì…ë ¥</div>
    </div>
  </div>

    <div class="row split">
      <div class="field">
        <div class="label">ì´ ë§¤ìˆ˜ì•¡</div>
        <div id="totalCost" class="value">-</div>
      </div>
      <div class="field">
        <div class="label">ì”ì•¡</div>
        <div id="balance" class="value">-</div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="label">ë§¤ë„ê°€ (í‰ë‹¨ê°€ +10%) / ë³´ìœ  ìˆ˜ëŸ‰</div>
    <div id="sellPrice" class="value sell">-</div>
  </div>

  <div class="row">
    <div class="label">í‰ë‹¨ê°€ / ê°€ëŠ¥ ìˆ˜ëŸ‰</div>
    <div id="avgBuyLine" class="value buy">-</div>
  </div>

  <div class="row">
    <div class="label">LOC í° ìˆ˜ ë§¤ìˆ˜ê°€ / ê°€ëŠ¥ ìˆ˜ëŸ‰</div>
    <div id="locBuy" class="value buy">-</div>
  </div>
  
  <div class="hint">
    â€» LOC í° ìˆ˜ ë§¤ìˆ˜ê°€ëŠ” â€œí‰ë‹¨ê°€ +5%â€ ì™€ â€œí˜„ì¬ê°€ +15%â€ ì¤‘ ë” ë‚®ì€ ê°€ê²©
  </div>

  <div class="row split">
    <div class="field">
      <div class="label">í‰ë‹¨ê°€ +5%</div>
      <div id="avgPlus5" class="value">-</div>
    </div>
    <div class="field">
      <div class="label">í˜„ì¬ê°€ +15%</div>
      <div id="pricePlus15" class="value">-</div>
    </div>
  </div>

  <div class="row split">
    <div class="field">
      <div class="label">40ë¶„í•  ê¸ˆì•¡</div>
      <div id="split40" class="value">-</div>
    </div>
    <div class="field">
      <div class="label">ì‚¬ìš© ê¸ˆì•¡ (80ë¶„í• )</div>
      <div id="halfSplit" class="value">-</div>
    </div>
  </div>
  <div class="box" style="margin-top:12px">
    <button id="buyBtn" style="width:100%;padding:12px;font-size:18px;
      font-weight:700;border-radius:10px;border:none;
      background:#22c55e;color:#020617;">
      ğŸŸ¢ ë§¤ìˆ˜
    </button>
    
    <button id="sellBtn" style="width:100%;padding:12px;font-size:18px;
      font-weight:700;border-radius:10px;border:none;
      background:#f87171;color:#020617;margin-top:8px">
      ğŸ”´ ë§¤ë„
    </button>
  </div>  
</div>

<script>
/* ===== ê¸°ë³¸ ì„¤ì • ===== */
const avgStatusEl = document.getElementById("avgStatus");
const params = new URLSearchParams(location.search);
const ticker = params.get("ticker");
if (!ticker) {
  alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤");
  location.href = "/";
}
const SHOW_DAYS = 252;

const seedInput = document.getElementById("seedInput");
const avgInput  = document.getElementById("avgInput");
  
const totalCostEl = document.getElementById("totalCost");
const balanceEl   = document.getElementById("balance");

const remainSeedEl = document.getElementById("remainSeed");  
const priceChartEl = document.getElementById("priceChart");
const rsiChartEl   = document.getElementById("rsiChart");

const currentPriceEl = document.getElementById("currentPrice");
const sellPriceEl = document.getElementById("sellPrice");
const avgPlus5El = document.getElementById("avgPlus5");
const pricePlus15El = document.getElementById("pricePlus15");
const locBuyEl = document.getElementById("locBuy");
const split40El = document.getElementById("split40");
const halfSplitEl = document.getElementById("halfSplit");
    
  /* ===== ì…ë ¥ê°’ ë³µì› ===== */
const savedSeed = localStorage.getItem(`seed_${ticker}`);
const savedAvg  = localStorage.getItem(`avg_${ticker}`);

if (savedSeed) seedInput.value = savedSeed;
if (savedAvg)  avgInput.value  = savedAvg;

  
document.getElementById("title").innerText = `ğŸ“ˆ ${ticker}`;

let prices = [], rsis = [], labels = [], latestPrice = null;
let holdQty = 0;
let totalCost = 0;
  
/* ===== ìœ í‹¸ ===== */
function authFetch(url, options = {}) {
  const token = localStorage.getItem("token");
  if (!token) {
    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤");
    location.href = "/";
    throw new Error("No token");
  }

  options.headers = {
    ...(options.headers || {}),
    "Authorization": "Bearer " + token,
    "Content-Type": "application/json"
  };

  return fetch(url, options);
}

function onlyNumber(v) {
  v = v.replace(/[^0-9.]/g, "");
  const p = v.split(".");
  if (p.length > 2) v = p[0] + "." + p.slice(1).join("");
  return v;
}
function formatNumber(v) {
  const [i, d] = v.split(".");
  const int = i.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  return d !== undefined ? `${int}.${d}` : int;
}
const getSeed = () => parseFloat(onlyNumber(seedInput.value) || "0");
const getAvg  = () => parseFloat(onlyNumber(avgInput.value) || "0");

/* ===== ë°ì´í„° ë¡œë“œ ===== */
authFetch(`/chart/${ticker}`)
  .then(r => r.json())
  .then(res => {
    const data = res.history;

    data.slice(-SHOW_DAYS).forEach(d => {
      labels.push(d.date);
      prices.push(d.price);
      rsis.push(
        typeof d.rsi === "number" ? d.rsi : null
      );
    });

    latestPrice = res.current_price ?? prices.at(-1);

    const mainLine = document.getElementById("mainPriceLine");
    const subLine  = document.getElementById("subPriceLine");

    mainLine.innerHTML = "";
    subLine.innerHTML = "";

    const updown = v => v < 0 ? "down" : "up";
    const sign = v => v > 0 ? "+" : "";

    // =======================
    // ì¥ì¤‘ (REGULAR)
    // =======================
    if (res.price_source === "REGULAR") {
      mainLine.innerHTML = `
        $${latestPrice.toFixed(2)}
        <span class="${updown(res.close_change)}">
          (${sign(res.close_change)}${res.close_change},
           ${sign(res.close_change_pct)}${res.close_change_pct}%)
        </span>
      `;
    }
    // =======================
    // ì¥ì „ / ì¥í›„
    // =======================
    else {
      // ì¢…ê°€
      mainLine.innerHTML = `
        $${res.close_price.toFixed(2)}
        <span class="${updown(res.close_change)}">
          (${sign(res.close_change)}${res.close_change},
           ${sign(res.close_change_pct)}${res.close_change_pct}%)
        </span>
      `;

      // ì‹œê°„ì™¸
      subLine.innerHTML = `
        <span class="badge ${res.price_source.toLowerCase()}">
          ${res.price_source}
        </span>
        $${latestPrice.toFixed(2)}
        <span class="${updown(res.after_change)}">
          (${sign(res.after_change)}${res.after_change},
           ${sign(res.after_change_pct)}${res.after_change_pct}%)
        </span>
      `;
    }

    drawCharts();
    updateLevels();
  });
  
fetch(`/api/avg-price/${ticker}`)
  .then(r => r.json())
  .then(d => {
    if (d.found) {
      avgInput.value = "$" + d.avg_price.toFixed(2);
      holdQty = d.qty;

      totalCost = d.total_cost || 0;   // âœ… ì¶”ê°€

      localStorage.setItem(`avg_${ticker}`, avgInput.value);
      avgStatusEl.innerText = "âœ… í•œêµ­íˆ¬ìì¦ê¶Œ ê³„ì¢Œì—ì„œ ê°€ì ¸ì˜´";
      avgStatusEl.style.color = "#22c55e";
    } else {
      holdQty = 0;
      totalCost = 0;                   // âœ… ì¶”ê°€

      avgStatusEl.innerText =
        "âš ï¸ í‰ë‹¨ê°€ ì¡°íšŒ ì‹¤íŒ¨ (ë¯¸ë³´ìœ  ë“±)";
      avgStatusEl.style.color = "#94a3b8";
    }
    updateLevels();
  })
  .catch(() => {
    holdQty = 0;
    totalCost = 0;                     // âœ… ì¶”ê°€

    avgStatusEl.innerText =
      "âŒ í‰ë‹¨ê°€ ì¡°íšŒ ì‹¤íŒ¨ (API ì˜¤ë¥˜)";
    avgStatusEl.style.color = "#f87171";
  });


/* ===== ì°¨íŠ¸ ===== */
function drawCharts() {
  const xTick = (_, i) => {
    if (!labels[i]) return "";
    const d = new Date(labels[i]);
    if (isNaN(d)) return "";
    return `${String(d.getFullYear()).slice(2)}.${d.getMonth() + 1}`;
  };

  new Chart(priceChartEl, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Price",
        data: prices,
        borderColor: "#60a5fa",
        borderWidth: 2,
        pointRadius: 0
      }]
    },
    options: {
      plugins: {
        legend: {
          labels: { color: "#e5e7eb" }
        }
      },
      scales: {
        x: {
          ticks: {
            maxTicksLimit: 6,
            callback: xTick,
            color: "#94a3b8"
          }
        },
        y: {
          ticks: { color: "#94a3b8" }
        }
      }
    }
  });

  new Chart(rsiChartEl, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "RSI (14)",
        data: rsis,
        borderColor: "#f87171",
        borderWidth: 2,
        pointRadius: 0
      }]
    },
    options: {
      plugins: {
        legend: {
          labels: { color: "#e5e7eb" }
        }
      },
      scales: {
        x: {
          ticks: {
            maxTicksLimit: 6,
            callback: xTick,
            color: "#94a3b8"
          }
        },
        y: {
          min: 10,
          max: 80,
          ticks: { color: "#94a3b8" }
        }
      }
    }
  });
}

/* ===== ê³„ì‚° ===== */
function updateLevels() {
  const seed = getSeed();
  const avg = getAvg();
  if (!seed || !latestPrice) return;

  /* ===== ì´ ë§¤ìˆ˜ì•¡ ì•ˆì „ ì²˜ë¦¬ ===== */
  const safeTotalCost = holdQty > 0 ? totalCost : 0;

  /* ===== ì”ì•¡ ===== */
  const balance = Math.max(seed - safeTotalCost, 0);

  /* ===== ë¶„í•  ê³„ì‚° (ì”ì•¡ ê¸°ì¤€) ===== */
  const split40 = balance / 40;
  const halfSplit = split40 / 2;

  /* ===== ê°€ê²© ê³„ì‚° ===== */
  const sell = avg ? avg * 1.10 : 0;
  const avg5 = avg ? avg * 1.05 : 0;
  const price15 = latestPrice * 1.15;
  const locBuy = avg ? Math.min(avg5, price15) : 0;

  const avgQty = avg ? Math.floor(halfSplit / avg) : 0;
  const locQty = locBuy ? Math.floor(halfSplit / locBuy) : 0;

  /* ===== í™”ë©´ ì¶œë ¥ ===== */

  // ì´ ë§¤ìˆ˜ì•¡
  const totalCostEl = document.getElementById("totalCost");
  if (totalCostEl) {
    totalCostEl.innerText =
      `$${safeTotalCost.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
  }

  // ì”ì•¡
  const balanceEl = document.getElementById("balance");
  if (balanceEl) {
    balanceEl.innerText =
      `$${balance.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
  }

  // ë§¤ë„ê°€
  sellPriceEl.innerText =
    avg
      ? `$${sell.toLocaleString(undefined, { maximumFractionDigits: 2 })} / ${holdQty} ì£¼`
      : "-";

  // í‰ë‹¨ê°€ +5%
  avgPlus5El.innerText =
    avg ? `$${avg5.toLocaleString(undefined, { maximumFractionDigits: 2 })}` : "-";

  // í˜„ì¬ê°€ +15%
  pricePlus15El.innerText =
    `$${price15.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;

  // ë§¤ìˆ˜ ë¼ì¸
  document.getElementById("avgBuyLine").innerText =
    avg
      ? `$${avg.toLocaleString(undefined, { maximumFractionDigits: 2 })} / ${avgQty} ì£¼`
      : "-";

  locBuyEl.innerText =
    avg
      ? `$${locBuy.toLocaleString(undefined, { maximumFractionDigits: 2 })} / ${locQty} ì£¼`
      : "-";

  split40El.innerText =
    `$${split40.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;

  halfSplitEl.innerText =
    `$${halfSplit.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
}

/* ===== ì…ë ¥ ===== */
seedInput.addEventListener("input", () => {
  const raw = onlyNumber(seedInput.value);
  seedInput.value = raw ? "$" + formatNumber(raw) : "";
  localStorage.setItem(`seed_${ticker}`, seedInput.value);
  updateLevels();
});

avgInput.addEventListener("input", () => {
  const raw = onlyNumber(avgInput.value);
  avgInput.value = raw ? "$" + formatNumber(raw) : "";
  localStorage.setItem(`avg_${ticker}`, avgInput.value);
  updateLevels();
});

  let startY = 0;
  let pulling = false;
  const indicator = document.getElementById("pullIndicator");

  window.addEventListener("touchstart", e => {
    if (window.scrollY === 0) {
      startY = e.touches[0].clientY;
      pulling = true;
    }
  });

  window.addEventListener("touchmove", e => {
    if (!pulling) return;
    const diff = e.touches[0].clientY - startY;
    if (diff > 0) {
      indicator.style.top = Math.min(diff - 40, 10) + "px";
      indicator.innerText = diff > 80 ? "ğŸ”„ ë†“ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨" : "â¬‡ï¸ ë‹¹ê²¨ì„œ ìƒˆë¡œê³ ì¹¨";
    }
  });

  window.addEventListener("touchend", e => {
    if (!pulling) return;
    const diff = e.changedTouches[0].clientY - startY;
    indicator.style.top = "-40px";
    pulling = false;
    if (diff > 80) {
      location.reload();
    }
  });
async function sendOrder(side, mode = "DEFAULT") {
  try {
    const seed = getSeed();
    const avg  = getAvg();
    if (!seed || !avg || !latestPrice) {
      alert("ì‹œë“œ / í‰ë‹¨ê°€ ì…ë ¥ í•„ìš”");
      return;
    }

    const body = {
      ticker,
      side,
      avg_price: avg,
      current_price: latestPrice,
      seed,
      mode
    };

    const res = await authFetch("/api/order/preview", {
      method: "POST",
      body: JSON.stringify(body)
    });
    if (!res.ok) {
      let err;
      try {
        const j = await res.json();
        err = j.detail || JSON.stringify(j);
      } catch {
        err = await res.text();
      }
      throw new Error(err);
    }

    const data = await res.json();
    function sideLabel(side) {
      if (side === "BUY_AVG") return "í‰ë‹¨ê°€ ë§¤ìˆ˜ (LOC)";
      if (side === "BUY_MARKET") return "í° ìˆ˜ ë§¤ìˆ˜ (LOC)";
      if (side === "SELL") return "í‰ë‹¨ê°€ +10% ë§¤ë„";
      return side;
    }

    const ok = confirm(
      `ğŸ“Œ ì£¼ë¬¸ í™•ì¸\n\n` +
      `ì¢…ëª©: ${ticker}\n` +
      `ì£¼ë¬¸: ${sideLabel(side)}\n` +
      `ê°€ê²©: $${data.price}\n` +
      `ìˆ˜ëŸ‰: ${data.qty} ì£¼\n\n` +
      `ì´ëŒ€ë¡œ ì£¼ë¬¸í• ê¹Œ?`
    );
    if (!ok) return;

    const final = await authFetch(`/api/order/execute/${data.order_id}`, {
      method: "POST"
    });

    if (!final.ok) {
      let err;
      try {
        const j = await final.json();
        err = j.detail || JSON.stringify(j);
      } catch {
        err = await final.text();
      }
      throw new Error(err);
    }

    const result = await final.json();
    alert("âœ… ì£¼ë¬¸ ì™„ë£Œ\n" + JSON.stringify(result, null, 2));

  } catch (e) {
    alert("âŒ ì£¼ë¬¸ ì‹¤íŒ¨\n" + e.message);
    console.error(e);
  }
}

document.getElementById("buyBtn").onclick = async () => {
  await sendOrder("BUY_MARKET");
  await sendOrder("BUY_AVG");
};

document.getElementById("sellBtn").onclick = () => {
  if (holdQty <= 0) {
    alert("âŒ ë§¤ë„ ê°€ëŠ¥ ìˆ˜ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤");
    return;
  }
  sendOrder("SELL");
};

</script>
</body>
</html>
